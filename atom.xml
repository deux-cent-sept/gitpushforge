<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Git push --forge</title>
  
  <subtitle>Forger la qualit√©, commit apr√®s commit.</subtitle>
  <link href="https://git-push-forge.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://git-push-forge.github.io/blog/"/>
  <updated>2023-10-19T16:52:33.297Z</updated>
  <id>https://git-push-forge.github.io/blog/</id>
  
  <author>
    <name>Maxence Mille &amp; Vincent Meziane</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Utiliser un Makefile dans Symfony</title>
    <link href="https://git-push-forge.github.io/blog/072023/makefile-symfony/"/>
    <id>https://git-push-forge.github.io/blog/072023/makefile-symfony/</id>
    <published>2023-07-26T19:47:16.000Z</published>
    <updated>2023-10-19T16:52:33.297Z</updated>
    
    <content type="html"><![CDATA[<h2 id="Introduction"><a href="#Introduction" class="headerlink" title="Introduction"></a>Introduction</h2><p>Le Makefile est un outil utilis√© dans le d√©veloppement logiciel pour automatiser des t√¢ches courantes. Bien que traditionnellement associ√© au syst√®me d‚Äôexploitation Unix et au projet GNU, il est largement utilis√© dans divers environnements, y compris les projets Symfony. </p><p>Dans cet article, nous allons voir comment mettre en place un Makefile avec Symfony, comment le faire proprement et de mani√®re facilit√©e gr√¢ce √† l‚Äôautocompl√©tion des commandes.</p><blockquote><p>Le Makefile va nous permettre de centraliser en un m√™me endroit toutes les commandes disponibles dans notre projet, mais aussi de cr√©er des process simplifi√©s pour les d√©veloppeurs qui rejoignent le projet. Il est √©galement possible de l‚Äôutiliser pour automatiser des t√¢ches de d√©ploiement, de tests, de qualit√© de code, etc.</p></blockquote><h2 id="Sommaire"><a href="#Sommaire" class="headerlink" title="Sommaire"></a>Sommaire</h2><ul><li><a href="#D%E2%80%99ou-vient-le-Makefile">D‚Äôo√π vient le Makefile</a></li><li><a href="#Comprendre-les-mots-cles">Comprendre les mots cl√©s</a></li><li><a href="#Organiser-son-Makefile">Organiser son Makefile</a></li><li><a href="#Un-Makefile-d%E2%80%99exemple">Un Makefile d‚Äôexemple üåü</a></li><li><a href="#Permettre-l%E2%80%99autocompletion">Permettre l‚Äôautocompl√©tion</a></li></ul><h2 id="D‚Äôou-vient-le-Makefile"><a href="#D‚Äôou-vient-le-Makefile" class="headerlink" title="D‚Äôo√π vient le Makefile"></a>D‚Äôo√π vient le Makefile</h2><h3 id="Lien-avec-GNU"><a href="#Lien-avec-GNU" class="headerlink" title="Lien avec GNU"></a>Lien avec GNU</h3><p>Le Makefile tire son nom de l‚Äôutilitaire ‚Äúmake‚Äù qui est utilis√© pour construire des programmes en lisant un fichier de description des d√©pendances appel√© Makefile. Le projet GNU a popularis√© l‚Äôutilisation du Makefile, le rendant essentiel pour la construction de logiciels.</p><p>Initialement, il √©tait, et est probablement toujours, utilis√© pour compiler des programmes √† partir de leur code source, en automatisant le processus de compilation, de liaison et d‚Äôautres t√¢ches de construction. Cependant, avec le temps, son utilisation s‚Äôest √©tendue pour automatiser diverses t√¢ches dans le d√©veloppement de logiciels.</p><blockquote><p>C‚Äôest de GNU que vient la grosse t√™te de Gnou que vous voyez probablement dans votre √©diteur ou dans les r√©sultats de recherche.</p></blockquote><h3 id="Exemple-d‚Äôutilisation"><a href="#Exemple-d‚Äôutilisation" class="headerlink" title="Exemple d‚Äôutilisation"></a>Exemple d‚Äôutilisation</h3><p>Le Makefile utilise une syntaxe sp√©cifique pour d√©finir des r√®gles, des cibles et des d√©pendances qui permettent de sp√©cifier les √©tapes n√©cessaires pour cr√©er des fichiers.</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">TARGET: DEPENDANCES</span></span><br><span class="line">&lt;TAB&gt;RULE</span><br><span class="line">&lt;TAB&gt;RULE</span><br><span class="line">&lt;TAB&gt;RULE</span><br></pre></td></tr></table></figure><blockquote><p>Attention √† bien respecter les tabulations et √† ne pas utiliser d‚Äôespaces pour d√©finir les r√®gles car vous risqueriez de rencontrer cette erreur : <em><code>Makefile:X: *** s√©parateur manquant. Arr√™t.</code></em><br>Cependant, un espace doit √™tre utilis√© avant chaque d√©pendance</p></blockquote><p><strong>La cible</strong> correspond souvent au nom du fichier que l‚Äôon souhaite g√©n√©rer (vendor, node_modules, etc..), mais nous verrons plus tard qu‚Äôon peut d√©tourner cette fonction pour cr√©er des cibles factices.</p><p><strong>Les d√©pendances</strong> sont les fichiers qui vont √™tre pris en compte par Make afin de d√©terminer si la cible doit √™tre recr√©√©e ou non. Si la date de modification des fichiers de d√©pendances est plus r√©cente que la cible, celle-ci doit √™tre recr√©√©e.</p><p><strong>Les r√®gles</strong> sont les commandes √† lancer pour construire correctement la cible</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">brique.txt:</span></span><br><span class="line">touch brique.txt</span><br><span class="line"></span><br><span class="line"><span class="section">mur.txt: brique.txt</span></span><br><span class="line">touch mur.txt</span><br></pre></td></tr></table></figure><p>Je vais lancer plusieurs fois <code>make mur.txt</code> et voir ce qu‚Äôil se passe :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># La premi√®re fois : make mur.txt</span></span><br><span class="line"><span class="built_in">touch</span> brique.txt <span class="comment"># La d√©pendance n&#x27;existe pas elle est donc cr√©√©e selon sa r√®gle de cr√©ation, un simple touch</span></span><br><span class="line"><span class="built_in">touch</span> mur.txt <span class="comment"># La cible est cr√©√©e selon sa r√®gle √©galement, un touch aussi</span></span><br><span class="line"><span class="comment"># La deuxi√®me fois: make mur.txt</span></span><br><span class="line">make: ¬´ mur.txt ¬ª est √† jour. <span class="comment"># mur.txt existe et aucune de ses d√©pendances n&#x27;a √©volu√©e. Il n&#x27;y a rien de nouveau</span></span><br><span class="line"><span class="comment"># J&#x27;√©cris un mot dans brique.txt -&gt; `echo &quot;coucou&quot; &gt;&gt; brique.txt` . Je relance `make mur.txt`</span></span><br><span class="line"><span class="built_in">touch</span> mur.txt <span class="comment">#brique.txt existe et n&#x27;a aucune d√©pendance √† analyser. En revanche mur.txt a une d√©pendance plus r√©cente que lui, on le recr√©e donc</span></span><br></pre></td></tr></table></figure><p>C‚Äôest le moment de complexifier l‚Äôexemple, et d‚Äôajouter des subtilit√©s, j‚Äôai ce makefile :</p><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">composer.json:</span></span><br><span class="line">composer init</span><br><span class="line"></span><br><span class="line"><span class="section">vendor: composer.json</span></span><br><span class="line">composer install</span><br><span class="line"></span><br><span class="line"><span class="section">run.sh: vendor</span></span><br><span class="line">touch run.sh</span><br></pre></td></tr></table></figure><p>Si je lance <code>make run.sh</code> , make va d‚Äôabord cr√©er la cible composer.json, puis vendor, puis run.sh. </p><blockquote><p>Notez qu‚Äôune cible peut √™tre un fichier, mais aussi un dossier complet. Attention cependant √† supprimer le dossier avant de le reg√©n√©rer s‚Äôil n‚Äôest pas correctement analys√© par make. Ici il vaut mieux ajouter <code>rm -rf vendor</code> avant le composer install.</p></blockquote><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">vendor: composer.json</span></span><br><span class="line">rm -rf vendor</span><br><span class="line">composer install</span><br></pre></td></tr></table></figure><h2 id="Comprendre-les-mots-cles"><a href="#Comprendre-les-mots-cles" class="headerlink" title="Comprendre les mots cl√©s"></a>Comprendre les mots cl√©s</h2><p>Familiarisons-nous d‚Äôabord avec quelques notions cl√©s.</p><ol><li><p><strong>DEFAULT_GOAL</strong> : Il s‚Äôagit de la cible qui est ex√©cut√©e par defaut lorsque vous appelez simplement <code>make</code> sans sp√©cifier de cible explicite. Cela permet d‚Äôex√©cuter automatiquement une t√¢che privil√©gi√©e quand on ne sait pas trop quoi lancer. Il pourrait s‚Äôagir d‚Äôun <code>make install</code> qui cr√©erait toutes les d√©pendances par exemple, backend, comme frontend. Mais nous allons voir qu‚Äôil peut √™tre int√©ressant de plutot appeler une commande <code>help</code>.</p></li><li><p><strong>.PHONY</strong> : (Fictive, Factice, Fausse) Permet de d√©clarer des cibles fictives. Les cibles d√©clar√©es en tant que phony sont consid√©r√©es comme ne construisant pas de fichier sp√©cifique. Cela permet plusieurs choses, d‚Äôabord d‚Äô√©viter les conflits avec des fichiers ayant le m√™me nom que les cibles. Par exemple vous ne pourrez pas lancer un <code>make build</code> que vous auriez d√©clar√© s‚Äôil existe un fichier <code>build</code> √† jour. Afin de se d√©barasser de ce lien on va ajouter cette nouvelle commande √† la liste des commandes fictives. On peut toutes les lister en d√©but de fichier ou les ajouter au cas par cas apr√®s chaque commande, c‚Äôest vous qui voyez</p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: build install ci docker etc...</span></span><br></pre></td></tr></table></figure><p> ou alors</p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">make build:</span><br><span class="line">[...]</span><br><span class="line"><span class="meta"><span class="keyword">.PHONY</span>: build</span></span><br></pre></td></tr></table></figure><blockquote><p>‚ôªÔ∏è C‚Äôest dans l‚Äôusage premier du makefile, celui qui permet de cr√©er des fichiers que cette v√©rification est pertinente. Mais comme nous n‚Äôallons pas nous appuyer sur cette m√©canique, vous pouvez vous passer de tous ces .PHONY et ajouter simplement <code>MAKEFLAGS += --always-make</code> en d√©but de fichier. Vos r√®gles seront syst√©matiquement jou√©es, m√™me si la cible a le m√™me nom qu‚Äôun fichier existant et √† jour.</p></blockquote></li><li><p><strong>Variables</strong> : Vous pouvez d√©clarer des variables et les utiliser partout dans le fichier. La d√©claration est simple <code>VARIABLE = valeur</code> puis <code>$(VARIABLE)</code> afin de l‚Äôutiliser<br>Par exemple : </p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">PHP = php</span><br><span class="line">SYMFONY = <span class="variable">$(PHP)</span> bin/console</span><br><span class="line"></span><br><span class="line"><span class="section">database:</span></span><br><span class="line"><span class="variable">$(SYMFONY)</span> doctrine:database:create --if-not-exists</span><br></pre></td></tr></table></figure><p> Il existe √©galement des variables g√©n√©rique, la plus int√©ressante pour nous √©tant <code>$@</code> qui repr√©sente la cible courante.</p> <figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="section">database:</span></span><br><span class="line">@echo <span class="string">&quot;J&#x27;√©x√©cute la commande <span class="variable">$@</span>&quot;</span></span><br><span class="line">@<span class="variable">$(SYMFONY)</span> doctrine:database:create --if-not-exists</span><br><span class="line"></span><br><span class="line"><span class="comment"># J&#x27;√©x√©cute la commande database</span></span><br></pre></td></tr></table></figure><blockquote><p>‚òù J‚Äôen profite pour introduire un autre outil qui est le <code>@</code> en d√©but de commande. Par defaut, make affichera les commandes qui sont √©x√©cut√©es, mais vous pouvez les dissimuler ainsi pour plus d‚Äôesth√©tisme. Et comme j‚Äôaime ce qui est esth√©tique, je vais le mettre absolument partout au profit d‚Äôune description de ce qui est lanc√© comme ici.</p></blockquote><p> Les autres variables g√©n√©riques</p><table><thead><tr><th>Symbole</th><th>Repr√©sente</th></tr></thead><tbody><tr><td>$?</td><td>Les d√©pendances qui ont √©t√© modifi√©es</td></tr><tr><td>$^</td><td>Toutes les d√©pendances</td></tr><tr><td>$+</td><td>Toutes les d√©pendances sans les doublons</td></tr><tr><td>$&lt;</td><td>La premi√®re d√©pendance</td></tr><tr><td>$@</td><td>La cible courante</td></tr></tbody></table></li><li><p><strong>Fonctions</strong> : Elles nous serviront tr√®s peu pour nos usages. Je vous laisse donc libre de les explorer mais je ne les d√©taillerai pas ici. Sachez seulement qu‚Äôon les utilise ainsi : <code>$(fonction argument1,argument2)</code> , qu‚Äôil en existe beaucoup mais qu‚Äôil est aussi possible d‚Äôen d√©finir.</p><p> Une liste de fonctions qui peuvent √™tre int√©ressantes :<br> <a href="https://www.gnu.org/software/make/manual/html_node/Functions.html">https://www.gnu.org/software/make/manual/html_node/Functions.html</a></p></li></ol><h2 id="Organiser-son-Makefile"><a href="#Organiser-son-Makefile" class="headerlink" title="Organiser son Makefile"></a>Organiser son Makefile</h2><p>Pour bien structurer notre Makefile, nous allons suivre cette organisation :</p><ol><li><strong>Variables</strong> : Nous d√©finirons des variables pour stocker des informations telles que les noms des fichiers, les ex√©cutables, les r√©pertoires, les options de compilation, etc. Cela rendra le Makefile plus flexible et facile √† faire √©voluer.</li><li><strong>Liste des commandes</strong> : Nous cr√©erons une liste exhaustive des commandes pr√©sentes dans le fichier et il sera possible de l‚Äôafficher par le biais d‚Äôune commande.</li><li><strong>Sections</strong> : Nous regrouperons les commandes connexes dans des sections logiques, ce qui rendra le Makefile plus organis√© et facile √† explorer.</li><li><strong>Documentation</strong> : Nous ajouterons des commentaires et des explications d√©taill√©es √† c√¥t√© de chaque commande pour faciliter la compr√©hension et permettre une meilleure collaboration entre les membres de l‚Äô√©quipe.</li></ol><h2 id="Un-Makefile-d‚Äôexemple"><a href="#Un-Makefile-d‚Äôexemple" class="headerlink" title="Un Makefile d‚Äôexemple"></a>Un Makefile d‚Äôexemple</h2><figure class="highlight makefile"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">.DEFAULT_GOAL = help</span><br><span class="line">MAKEFLAGS += --always-make</span><br><span class="line"></span><br><span class="line"><span class="comment"># ============= Variables üß∞ =============</span></span><br><span class="line">ARGUMENTS = <span class="variable">$(<span class="built_in">filter</span>-out <span class="variable">$@</span>,<span class="variable">$(MAKECMDGOALS)</span>)</span></span><br><span class="line"></span><br><span class="line">PROJECT = nom_du_projet</span><br><span class="line">WEB_CONTAINER = web</span><br><span class="line">DOCKER_USER_ID = www-data</span><br><span class="line">SYMFONY = php bin/console</span><br><span class="line">EXEC_WEB = docker-compose exec -u<span class="variable">$(DOCKER_USER_ID)</span>:<span class="variable">$(DOCKER_USER_ID)</span> <span class="variable">$(WEB_CONTAINER)</span></span><br><span class="line">PHPUNIT = ./vendor/bin/phpunit</span><br><span class="line">PHPSTAN = ./vendor/bin/phpstan</span><br><span class="line">PHP_CS_FIXER = ./vendor/bin/php-cs-fixer</span><br><span class="line"></span><br><span class="line"><span class="comment">## ============= Obtenir des infos ‚ùì =============</span></span><br><span class="line"><span class="section">help: ## Affiche la liste des commandes disponibles</span></span><br><span class="line">@grep -E &#x27;(^[a-zA-Z%0-9_-]+:.*?<span class="comment">##.*$$)|(^##)&#x27; $(MAKEFILE_LIST) | awk &#x27;BEGIN &#123;FS = &quot;:.*?## &quot;&#125;&#123;printf &quot;\033[32m%-30s\033[0m %s\n&quot;, $$1, $$2&#125;&#x27; | sed -e &#x27;s/\[32m##/[33m/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="section">list-vars: ## Affiche la liste des variables du Makefile</span></span><br><span class="line">@grep -E &#x27;^[a-zA-Z_-]+ = .*$$&#x27; <span class="variable">$(MAKEFILE_LIST)</span> | awk &#x27;BEGIN &#123;FS = <span class="string">&quot; = &quot;</span>&#125;&#123;printf <span class="string">&quot;\033[32m%-30s\033[0m %s\n&quot;</span>, $$1, $$2&#125;&#x27; | sed -e &#x27;s/\[32m<span class="comment">##/[33m/&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ============= Installer le projet üèóÔ∏è =============</span></span><br><span class="line"><span class="section">composer: ## Installe les d√©pendances PHP du projet</span></span><br><span class="line">@rm -rf vendor</span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> composer install</span><br><span class="line"></span><br><span class="line"><span class="section">node_modules: ## Installe les d√©pendances NodeJS du projet</span></span><br><span class="line">@rm -rf node_modules</span><br><span class="line">@npm install</span><br><span class="line"></span><br><span class="line"><span class="section">watch: ## Lance le watcher pour les assets du projet</span></span><br><span class="line">@npm run watch</span><br><span class="line"></span><br><span class="line"><span class="section">build-front: ## Build les assets du projet</span></span><br><span class="line">@npm run build</span><br><span class="line"></span><br><span class="line"><span class="section">update: ## Met √† jour les d√©pendances PHP du projet</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> composer update --with-all-dependencies</span><br><span class="line"></span><br><span class="line"><span class="section">assets: ## Installe les assets du projet</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> assets:install public/</span><br><span class="line"></span><br><span class="line"><span class="section">database: ## Cr√©e la base de donn√©es et le sch√©ma</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> doctrine:database:drop --force --if-exists</span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> doctrine:database:create --if-not-exists</span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> doctrine:schema:create</span><br><span class="line"></span><br><span class="line"><span class="section">fixtures: ## Ajoute les fixtures</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> doctrine:fixtures:load --no-interaction</span><br><span class="line"></span><br><span class="line"><span class="section">env: ## Cr√©e le fichier .env.local √† partir du .env</span></span><br><span class="line">@cp .env .env.local</span><br><span class="line"></span><br><span class="line"><span class="section">install: composer database assets build-front cc warmup ## Installe l&#x27;environnement de base n√©cessaire au d√©ploiement en production</span></span><br><span class="line"><span class="section">install-dev: composer database fixtures assets build-front cc warmup ## Installe l&#x27;environnement de base n√©cessaire au d√©veloppement</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## ============= Utiliser Symfony üéº =============</span></span><br><span class="line"><span class="section">symfony: ## Utilise les commandes Symfony du projet (ex: make symfony debug:router)</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> <span class="variable">$(ARGUMENTS)</span></span><br><span class="line"></span><br><span class="line"><span class="section">cc: ## Vide le cache</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> c:c</span><br><span class="line"></span><br><span class="line"><span class="section">warmup: ## Pr√©chauffe le cache</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(SYMFONY)</span> cache:warmup</span><br><span class="line"></span><br><span class="line"><span class="comment">## ============= Utiliser Docker üêã =============</span></span><br><span class="line"><span class="section">start: ## D√©marre tous les containers</span></span><br><span class="line">@docker compose up --detach</span><br><span class="line"></span><br><span class="line"><span class="section">stop: ## Stop tous les containers</span></span><br><span class="line">@docker-compose stop</span><br><span class="line"></span><br><span class="line"><span class="section">down: ## Supprime tous les containers</span></span><br><span class="line">@docker-compose down --remove-orphans</span><br><span class="line"></span><br><span class="line"><span class="section">build: ## Rebuild les images docker</span></span><br><span class="line">@docker compose build</span><br><span class="line"></span><br><span class="line"><span class="section">logs: ## Affiche les logs des containers</span></span><br><span class="line">@docker-compose logs -f</span><br><span class="line"></span><br><span class="line"><span class="section">bash: ## Attache un shell au container web</span></span><br><span class="line">@docker-compose exec web bash</span><br><span class="line"></span><br><span class="line"><span class="comment">## ============= Qualit√© du code üëÄ =============</span></span><br><span class="line"><span class="section">test: ## Lance les tests PHPUnit avec un filtre et un testsuite optionnels</span></span><br><span class="line">@<span class="variable">$(<span class="built_in">eval</span> testsuite ?= all)</span></span><br><span class="line">@<span class="variable">$(<span class="built_in">eval</span> <span class="built_in">filter</span> ?= &#x27;.&#x27;)</span></span><br><span class="line">@echo <span class="string">&quot;Test suite : <span class="variable">$(testsuite)</span>&quot;</span></span><br><span class="line">@echo <span class="string">&quot;Filtre : <span class="variable">$(filter)</span>&quot;</span></span><br><span class="line">@echo <span class="string">&quot;&quot;</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(PHPUNIT)</span> --testsuite=<span class="variable">$(testsuite)</span> --filter=<span class="variable">$(filter)</span> --stop-on-failure</span><br><span class="line"></span><br><span class="line"><span class="section">test-all: ## Lance tous les tests PHPUnit</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(PHPUNIT)</span> --stop-on-failure</span><br><span class="line"></span><br><span class="line"><span class="section">fix: ## Lance php-cs-fixer</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(PHP_CS_FIXER)</span> fix --verbose</span><br><span class="line"></span><br><span class="line"><span class="section">phpstan: ## Lance PHPStan</span></span><br><span class="line">@<span class="variable">$(EXEC_WEB)</span> <span class="variable">$(PHPSTAN)</span> analyse -c phpstan.neon --memory-limit=-1</span><br><span class="line"></span><br><span class="line"><span class="section">ci: fix phpstan test-all ## Lance tous les tests pour l&#x27;int√©gration continue</span></span><br></pre></td></tr></table></figure><p>Voici le fichier Makefile que j‚Äôutilise sur un de mes projets, il est assez court, mais organis√©. Il est grandement inspir√© de l‚Äôexcellent Makefile que nous fournit Lo√Øc Vernet sur son blog <a href="https://www.strangebuzz.com/fr/snippets/le-makefile-parfait-pour-symfony">Juste ici</a>  </p><p>Bien sur, beaucoup de mes recettes d√©pendent de la fa√ßon dont est construit mon environnement, j‚Äôai l‚Äôhabitude d‚Äôutiliser php et composer, directement dans mon container, afin que tout le monde partage les m√™mes versions.</p><blockquote><p>ü•∏ Pour avoir une id√©e plus claire de la configuration autour de ce makefile, voici ce que j‚Äôutilise:</p><ul><li><strong>Docker-compose</strong> pour orchestrer mes container docker</li><li>Un container web bas√© sur une image <strong>php:8.1-apache</strong> auquel j‚Äôajoute composer et quelques extensions. </li><li>Un container de base de donn√©e <strong>postgreSQL</strong></li><li>Un container <strong>adminer</strong> pour g√©rer la base de donn√©e.</li><li>J‚Äôutilise ma version locale de <strong>node</strong> et <strong>npm</strong> pour g√©rer les assets, mais je pourrais tout √† fait utiliser un container node pour cela.</li></ul></blockquote><p>De la m√™me mani√®re, l‚Äôutilisateur qui va ex√©cuter les commandes n‚Äôa pas forc√©ment besoin d‚Äô√™tre pr√©cis√© selon que vous utilisez un entrypoint ou pas.<br>Ce que je veux dire c‚Äôest que vous allez s√ªrement devoir adapter 2 ou 3 choses, mais voil√† une bonne base.</p><p>Comme je l‚Äôai expliqu√© plus haut, j‚Äôai ajout√© une commande <code>help</code> qui affiche la liste des commandes disponibles et c‚Äôest le DEFAULT_GOAL. Cela permettra aux d√©veloppeurs de voir rapidement les commandes disponibles et de les utiliser sans avoir √† consulter la documentation.</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"> ============= Obtenir des infos ‚ùì ============= </span><br><span class="line"><span class="built_in">help</span>                           Affiche la liste des commandes disponibles</span><br><span class="line">list-vars                      Affiche la liste des variables <span class="built_in">du</span> Makefile</span><br><span class="line"> ============= Installer le projet üèóÔ∏è ============= </span><br><span class="line">composer                       Installe les d√©pendances PHP <span class="built_in">du</span> projet</span><br><span class="line">node_modules                   Installe les d√©pendances NodeJS <span class="built_in">du</span> projet</span><br><span class="line">watch                          Lance le watcher pour les assets <span class="built_in">du</span> projet</span><br><span class="line">build-front                    Build les assets <span class="built_in">du</span> projet</span><br><span class="line">update                         Met √† jour les d√©pendances PHP <span class="built_in">du</span> projet</span><br><span class="line">assets                         Installe les assets <span class="built_in">du</span> projet</span><br><span class="line">database                       Cr√©e la base de donn√©es et le sch√©ma</span><br><span class="line">fixtures                       Ajoute les fixtures</span><br><span class="line"><span class="built_in">env</span>                            Cr√©e le fichier .env.local √† partir <span class="built_in">du</span> .<span class="built_in">env</span></span><br><span class="line">install                        Installe l¬¥environnement de base n√©cessaire au d√©ploiement en production</span><br><span class="line">install-dev                    Installe l¬¥environnement de base n√©cessaire au d√©veloppement</span><br><span class="line"> ============= Utiliser Symfony üéº ============= </span><br><span class="line">symfony                        Utilise les commandes Symfony <span class="built_in">du</span> projet (ex: make symfony debug:router)</span><br><span class="line">cc                             Vide le cache</span><br><span class="line">warmup                         Pr√©chauffe le cache</span><br><span class="line"> ============= Utiliser Docker üêã ============= </span><br><span class="line">start                          D√©marre tous les containers</span><br><span class="line">stop                           Stop tous les containers</span><br><span class="line">down                           Supprime tous les containers</span><br><span class="line">build                          Rebuild les images docker</span><br><span class="line">logs                           Affiche les logs des containers</span><br><span class="line">bash                           Attache un shell au container web</span><br><span class="line"> ============= Qualit√© <span class="built_in">du</span> code üëÄ ============= </span><br><span class="line"><span class="built_in">test</span>                           Lance les tests PHPUnit avec un filtre et un testsuite optionnels</span><br><span class="line">test-all                       Lance tous les tests PHPUnit</span><br><span class="line">fix                            Lance php-cs-fixer</span><br><span class="line">phpstan                        Lance PHPStan</span><br><span class="line">ci                             Lance tous les tests pour l¬¥int√©gration <span class="built_in">continue</span></span><br></pre></td></tr></table></figure><h2 id="Permettre-l‚Äôautocompletion"><a href="#Permettre-l‚Äôautocompletion" class="headerlink" title="Permettre l‚Äôautocompl√©tion"></a>Permettre l‚Äôautocompl√©tion</h2><p>Pour rendre l‚Äôutilisation du Makefile encore plus agr√©able, nous pouvons ajouter la prise en charge de l‚Äôautocompl√©tion des commandes. Cela permettra aux d√©veloppeurs d‚Äôobtenir des suggestions de commandes lorsqu‚Äôils utilisent l‚Äôonglet de compl√©tion dans leur terminal.</p><p>Pour permettre l‚Äôautocompl√©tion, nous pouvons utiliser le paquet ‚Äúmake‚Äù fourni avec la plupart des distributions Linux. Vous pouvez v√©rifier s‚Äôil est d√©j√† install√© sur votre syst√®me en ex√©cutant la commande suivante :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">make --version</span><br></pre></td></tr></table></figure><p>Si le paquet n‚Äôest pas d√©j√† install√©, vous pouvez l‚Äôinstaller en utilisant le gestionnaire de paquets de votre syst√®me.</p><p>Une fois qu‚Äôil est install√©, v√©rifiez si vous avez l‚Äôautocompl√©tion activ√©e en √©crivant <code>make</code> puis en appuyant sur la touche <code>tab</code>. Si vous obtenez une liste de noms de fichiers ou de dossiers c‚Äôest que l‚Äôautocompl√©tion est d√©j√† activ√©e.</p><p>Si ce n‚Äôest pas le cas vous pouvez taper les commandes suivantes pour ajouter √† votre fichier ~&#x2F;.zshrc ou ~&#x2F;.bashrc la compl√©tion automatique pour make :</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">echo</span> <span class="string">&quot;#Ajout de l&#x27;autocompl√©tion pour make&quot;</span> &gt;&gt; ~/.bashrc</span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;source /usr/share/bash-completion/completions/make&quot;</span> &gt;&gt; ~/.bashrc</span><br></pre></td></tr></table></figure><p>Apr√®s avoir relanc√© votre terminal, vous pourrez b√©n√©ficier de l‚Äôautocompl√©tion en utilisant la touche <code>tab</code> . Et voil√† !</p>]]></content>
    
    
    <summary type="html">Le Makefile est un outil puissant utilis√© dans le d√©veloppement logiciel pour automatiser des t√¢ches courantes. Bien que traditionnellement associ√© au syst√®me d&#39;exploitation Unix et au projet GNU, il est largement utilis√© dans divers environnements, y compris les projets Symfony.</summary>
    
    
    
    
    <category term="Outils, Symfony, Makefile" scheme="https://git-push-forge.github.io/blog/tags/Outils-Symfony-Makefile/"/>
    
  </entry>
  
</feed>
